<html>

<head>
    <script src='https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0'></script>
    <script
        src='https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js'></script>
    <link rel='icon' type='image/x-icon'
        href='data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKcAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAAqAAAAAAAAAAAAAAAAAAAALIAAAD/AAAA4AAAANwAAADcAAAA3AAAANwAAADcAAAA3AAAANwAAADcAAAA4AAAAP8AAACxAAAAAAAAAKYAAAD/AAAAuwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC/AAAA/wAAAKkAAAD6AAAAzAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAN8AAAD/AAAA+gAAAMMAAAAAAAAAAgAAAGsAAABrAAAAawAAAGsAAABrAAAAawAAAGsAAABrAAAADAAAAAAAAADaAAAA/wAAAPoAAADDAAAAAAAAAIsAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAANEAAAAAAAAA2gAAAP8AAAD6AAAAwwAAAAAAAAAAAAAAMgAAADIAAAAyAAAAMgAAADIAAAAyAAAAMgAAADIAAAAFAAAAAAAAANoAAAD/AAAA+gAAAMMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADaAAAA/wAAAPoAAADDAAAAAAAAADwAAAB8AAAAAAAAAGAAAABcAAAAAAAAAH8AAABKAAAAAAAAAAAAAAAAAAAA2gAAAP8AAAD6AAAAwwAAAAAAAADCAAAA/wAAACkAAADqAAAA4QAAAAAAAAD7AAAA/wAAALAAAAAGAAAAAAAAANoAAAD/AAAA+gAAAMMAAAAAAAAAIwAAAP4AAAD/AAAA/wAAAGAAAAAAAAAAAAAAAMkAAAD/AAAAigAAAAAAAADaAAAA/wAAAPoAAADDAAAAAAAAAAAAAAAIAAAAcAAAABkAAAAAAAAAAAAAAAAAAAAAAAAAEgAAAAAAAAAAAAAA2gAAAP8AAAD7AAAAywAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAN4AAAD/AAAAqwAAAP8AAACvAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALIAAAD/AAAAsgAAAAAAAAC5AAAA/wAAAMoAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMkAAAD/AAAAvAAAAAAAAAAAAAAAAAAAAKwAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAArQAAAAAAAAAAwAMAAIABAAAf+AAAP/wAAD/8AAAgBAAAP/wAAD/8AAA//AAAJIwAADHEAAA//AAAP/wAAB/4AACAAQAAwAMAAA=='>
</head>
<style>
    h2 {
        padding: 0px 20px 0px 20px;
    }

    :root {
        color-scheme: dark;
        font-family: Helvetica, sans-serif;
    }

    canvas {
        user-select: none;
    }

    @media (prefers-color-scheme: light) {
        body {
            background-color: #eee;
        }
    }

    @media (prefers-color-scheme: dark) {
        body {
            background-color: #1c2227;
            color: #e2e1d7;
        }
    }

    .canvas-container {
        width: 900;
        /* overflow-x: scroll; */
        margin-left: 20px;
    }

    .header {
        margin-top: 20px;
        margin-left: 20px;
    }

    .header p {
        display: inline;
        vertical-align: top;
        line-height: 28px;
        margin-right: 20px;
    }

    .header {
        display: flex;
        justify-content: space-between;
    }

    .header .stats {
        margin-top: 20px;
        line-height: 28px;
    }

    .header h1 {
        display: inline;
        vertical-align: top;
        line-height: 28px;
    }

    .filters {
        margin-left: 20px;
        display: flex;
        justify-content: space-between;
        width: 60%;
    }
</style>

<body>
    <div class='header'>
        <h1>Robot Framework Dashboard {{ date }}</h1>
        <div class='stats'>
            <p id='suiteCount'></p>
            <p id='testCount'></p>
            <p id='keywordCount'></p>
        </div>
    </div>

    <div class='filters'>
        <div>
            <label for='runs'>Runs</label>
            <select id='runs'></select>
        </div>
        <div>
            <label for='tag'>Tag</label>
            <select id='tag'></select>
        </div>
        <div>
            <label for='fromDate'>From Date</label>
            <input id='fromDate' type='date'></input>
        </div>
        <div>
            <label for='fromTime'>From Time</label>
            <input id='fromTime' type='time'></input>
        </div>
        <div>
            <label for='toDate'>To Date</label>
            <input id='toDate' type='date'></input>
        </div>
        <div>
            <label for='toTime'>To Time</label>
            <input id='toTime' type='time'></input>
        </div>
        <div>
            <button id='clearFilters'>Clear Filters</button>
        </div>
    </div>

    <h2>Run Statistics</h2>
    <div style='display: flex'>
        <div class='canvas-container'>
            <canvas id='suiteStatistics' width='900' , height='540'></canvas>
        </div>
        <div class='canvas-container'>
            <canvas id='suitesOverTime' width='900' , height='540'></canvas>
        </div>
    </div>
    <h2>Suite Statistics</h2>
    <div style='display: flex'>
        <div class='canvas-container'>
            <canvas id='suiteStatistics' width='900' , height='540'></canvas>
        </div>
        <div class='canvas-container'>
            <canvas id='suitesOverTime' width='900' , height='540'></canvas>
        </div>
    </div>
    <h2>Test Statistics</h2>
    <div style='display: flex'>
        <div class='canvas-container'>
            <canvas id='suiteStatistics' width='900' , height='540'></canvas>
        </div>
        <div class='canvas-container'>
            <canvas id='suitesOverTime' width='900' , height='540'></canvas>
        </div>
    </div>
    <h2>Keyword Statistics</h2>
    <div style='display: flex'>
        <div class='canvas-container'>
            <canvas id='suiteStatistics' width='900' , height='540'></canvas>
        </div>
        <div class='canvas-container'>
            <canvas id='suitesOverTime' width='900' , height='540'></canvas>
        </div>
    </div>

</body>
<script>
    // theme
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        Chart.defaults.color = '#e2e1d7';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';
        Chart.defaults.backgroundColor = 'rgba(255,255,0,0.1)';
        Chart.defaults.elements.line.borderColor = 'rgba(255,255,0,0.4)';
    }
    // prepare input data
    var suites = {{ suites }}.sort((a, b) => new Date(a.run_start).getTime() - new Date(b.run_start).getTime());
    var tests = {{ tests }}.sort((a, b) => new Date(a.run_start).getTime() - new Date(b.run_start).getTime());
    // var keywords = {{keywords}}.sort((a, b) => new Date(a.run_start).getTime() - new Date(b.run_start).getTime());

    // set default values
    document.getElementById('suiteCount').innerText = 'Suites: ' + suites.length
    document.getElementById('testCount').innerText = 'Tests: ' + tests.length
    document.getElementById('keywordCount').innerText = 'Keywords: ' + {{ keywords }}
    set_lowest_highest_dates(suites)

    // initialize graphs and filters
    add_runs_in_select()
    add_tags_in_select()
    var suiteStatisticsGraph
    var suitesOverTimeGraph
    update_all_graphs()

    // eventlisteners for filters
    document.getElementById('runs').addEventListener('change', update_all_graphs)
    document.getElementById('tag').addEventListener('change', update_all_graphs)
    document.getElementById('fromDate').addEventListener('change', update_all_graphs)
    document.getElementById('fromTime').addEventListener('change', update_all_graphs)
    document.getElementById('toDate').addEventListener('change', update_all_graphs)
    document.getElementById('toTime').addEventListener('change', update_all_graphs)
    document.getElementById('clearFilters').addEventListener('click', clear_filters)

    function set_lowest_highest_dates(suites) {
        var lowest = ''
        var highest = ''
        for (suite of suites) {
            var suiteRunStart = new Date(suite.run_start)
            // set initial values
            if (lowest == '') { lowest = suiteRunStart}
            if (highest == '') { lowest = suiteRunStart}
            // update if found an earlier or later run
            if (suiteRunStart < lowest) { lowest = suiteRunStart}
            if (suiteRunStart > highest) { highest = suiteRunStart}
        }
        document.getElementById('fromDate').value = lowest.toISOString().split('T')[0]
        document.getElementById('fromTime').value = (lowest.toISOString().split('T')[1]).substring(0, 5)
        document.getElementById('toDate').value = highest.toISOString().split('T')[0]
        document.getElementById('toTime').value = (highest.toISOString().split('T')[1]).substring(0, 5)
    }

    function update_all_graphs() {
        var filtered = filter_runs(suites)
        filtered = filter_tags(filtered)
        filtered = filter_dates(filtered)

        if (suiteStatisticsGraph) { suiteStatisticsGraph.destroy() }
        if (suitesOverTimeGraph) { suitesOverTimeGraph.destroy() }
      
        create_suite_statistics_graph(filtered)
        create_suites_over_time_graph(filtered)
    }

    function filter_runs(suites) {
        var run = document.getElementById('runs').value
        var filtered = {}
        for (const [key, value] of Object.entries(suites)) {
            if (run != 'All' && value.name != run) {
                continue
            } else {
                filtered[key] = value
            }
        }
        return filtered
    }

    function filter_tags(suites) {
        var tag = document.getElementById('tag').value
        var filtered = {}
        for (const [key, value] of Object.entries(suites)) {
            if (tag != 'All') {
                var runTags = value.tags.split(',')
                for (runTag of runTags) {
                    if (tag != runTag) {
                        continue
                    } else {
                        filtered[key] = value
                    }
                }
            } else {
                filtered = suites
            }
        }
        return filtered
    }

    function filter_dates(suites) {
        var fromDate = document.getElementById('fromDate').value
        var fromTime = document.getElementById('fromTime').value
        var toDate = document.getElementById('toDate').value
        var toTime = document.getElementById('toTime').value

        var filtered = {}
        if (fromDate && fromTime && toDate && toTime) {
            var fromDateTime = new Date(`${fromDate} ${fromTime}:00`)
            var toDateTime = new Date(`${toDate} ${toTime}:00`)
            if (fromDateTime <= toDateTime) {
                for (const [key, value] of Object.entries(suites)) {
                    var run_start = new Date(value.run_start)
                    if (run_start < fromDateTime || run_start > toDateTime) {
                        continue
                    } else {
                        filtered[key] = value
                    }
                }
            } else {
                // you end up here if fromDate > toDate
                filtered = suites
            }
        } else {
            // no dates or not all value are provided
            filtered = suites
        }
        return filtered
    }

    function clear_filters() {
        document.getElementById('runs').value = 'All'
        document.getElementById('tag').value = 'All'
        set_lowest_highest_dates(suites)
        update_all_graphs()
    }

    function add_runs_in_select() {
        var runs = []
        for (suite of suites) {
            if (!runs.includes(suite.name)) {
                runs.push(suite.name)
            }
        }
        runsSelect = document.getElementById('runs');
        runsSelect.options[runsSelect.options.length] = new Option('All', 'All');
        for (run of runs) {
            runsSelect.options[runsSelect.options.length] = new Option(run, run);
        }
    }

    function add_tags_in_select() {
        var tags = []
        for (suite of suites) {
            var suiteTags = suite.tags.split(',')
            for (tag of suiteTags) {
                if (!tags.includes(tag) && tag != '') {
                    tags.push(tag)
                }
            }
        }
        tagsSelect = document.getElementById('tag');
        tagsSelect.options[tagsSelect.options.length] = new Option('All', 'All');
        for (tag of tags) {
            tagsSelect.options[tagsSelect.options.length] = new Option(tag, tag);
        }
    }

    function create_suite_statistics_graph(filtered) {
        var passed = []
        var failed = []
        var skipped = []
        var labels = []
        for (const [key, value] of Object.entries(filtered)) {
            passed.push(value.passed)
            failed.push(value.failed)
            skipped.push(value.skipped)
            labels.push(`${value.full_name}: ${value.run_start}`)
        }

        var suiteStatisticsData
        suiteStatisticsData = {
            labels: labels,
            datasets: [
                {
                    label: 'Failed',
                    data: failed,
                    backgroundColor: '#ce3e01',
                    stack: 'Stack 0',
                },
                {
                    label: 'Skipped',
                    data: skipped,
                    backgroundColor: '#fed84f',
                    stack: 'Stack 0',
                },
                {
                    label: 'Passed',
                    data: passed,
                    backgroundColor: '#97bd61',
                    stack: 'Stack 0',
                },
            ]
        };

        Chart.register(ChartDataLabels);
        suiteStatisticsGraph = new Chart('suiteStatistics', {
            type: 'bar',
            data: suiteStatisticsData,
            options: {
                scales: {
                    x: {
                        ticks: {
                            display: true,
                            callback: function (value) {
                                return this.getLabelForValue(value).split(':')[0]
                            },
                        },
                        title: {
                            display: true,
                            text: 'Run'
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Amount Of Tests'
                        },
                        grace: '5%'
                    }
                },
                interaction: {
                    mode: 'x'
                },
                responsive: false,
                plugins: {
                    legend: {
                        display: false,
                        labels: {
                            family: 'Helvetica, sans-serif',
                        }
                    },
                    datalabels: {
                        color: '#000000',
                        align: 'center',
                        anchor: 'center',
                        formatter: function (value) {
                            if (value > 0) {
                                return value
                            } else {
                                value = '';
                                return value;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Suite Statistics'
                    }
                }
            }
        });
    }

    function create_suites_over_time_graph(filtered) {
        var labels = []
        var sets = []
        var datasets = []
        for (const [key, value] of Object.entries(filtered)) {
            var full_name = value.full_name
            var run_start = new Date(value.run_start)
            var elapsed_s = value.elapsed_s
            if (labels.includes(full_name)) {
                var values = sets[full_name]
                values.push({ x: run_start, y: elapsed_s })
                sets[full_name] = values
            } else {
                labels.push(full_name)
                sets[full_name] = [{ x: run_start, y: elapsed_s }]
            }
        }
        for (const [key, value] of Object.entries(sets)) {
            datasets.push({ label: key, fill: false, borderDash: [5, 5], data: value })
        }

        suitesOverTimeGraph = new Chart('suitesOverTime', {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: false,
                plugins: {
                    title: {
                        text: 'Suite Duration Over Time',
                        display: true
                    },
                    datalabels: {
                        display: false,
                    },
                    legend: {
                        display: true,
                        position: 'right',
                        labels: {
                            family: 'Helvetica, sans-serif',
                            color: '#e2e1d7'
                        }
                    },
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            tooltipFormat: 'dd.MM.yyyy - HH:mm:ss.SSS'
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Elapsed (seconds)'
                        },
                        grace: '5%'
                    }
                }
            }
        });
    }
</script>

<body>

</html>

<!-- var chart = new CanvasJS.Chart('chartContainer',
                               {
  title: {
    text: 'How long an event occurred for on a given day'
  },
  axisY: {
    minimum: (new Date(2016, 0, 28, 11, 30)).getTime(),            
    interval: (1 * 60 * 60 * 1000),
    labelFormatter: function(e){
      return CanvasJS.formatDate(e.value, 'DD - h:mm TT');
    },
    gridThickness: 2
  },

  toolTip:{
    contentFormatter: function ( e ) {
      return '<strong>' + e.entries[0].dataPoint.label + '</strong></br> Start: ' +  CanvasJS.formatDate(e.entries[0].dataPoint.y[0], 'DD - h:mm TT') + '</br>End : ' +  CanvasJS.formatDate(e.entries[0].dataPoint.y[1], 'DD - h:mm TT');  
    }},

  data: [
    {
      type: 'rangeBar',
      dataPoints: [
        { label: 'Walking', y: [(new Date(2016, 0, 28, 12, 20)).getTime(), (new Date(2016, 0, 28, 13, 00)).getTime()] },
        { label: 'Walking', y: [(new Date(2016, 0, 28, 15, 20)).getTime(), (new Date(2016, 0, 28, 18, 00)).getTime()] },
        { label: 'Running', y: [(new Date(2016, 0, 28, 13, 20)).getTime(), (new Date(2016, 0, 28, 14, 20)).getTime()] },
        { label: 'Walking', y: [(new Date(2016, 0, 28, 14, 20)).getTime(), (new Date(2016, 0, 28, 15, 00)).getTime()] }
      ]
    }
  ]                      
});
chart.render(); -->