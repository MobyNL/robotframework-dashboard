<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
        <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKcAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAAqAAAAAAAAAAAAAAAAAAAALIAAAD/AAAA4AAAANwAAADcAAAA3AAAANwAAADcAAAA3AAAANwAAADcAAAA4AAAAP8AAACxAAAAAAAAAKYAAAD/AAAAuwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC/AAAA/wAAAKkAAAD6AAAAzAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAN8AAAD/AAAA+gAAAMMAAAAAAAAAAgAAAGsAAABrAAAAawAAAGsAAABrAAAAawAAAGsAAABrAAAADAAAAAAAAADaAAAA/wAAAPoAAADDAAAAAAAAAIsAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAANEAAAAAAAAA2gAAAP8AAAD6AAAAwwAAAAAAAAAAAAAAMgAAADIAAAAyAAAAMgAAADIAAAAyAAAAMgAAADIAAAAFAAAAAAAAANoAAAD/AAAA+gAAAMMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADaAAAA/wAAAPoAAADDAAAAAAAAADwAAAB8AAAAAAAAAGAAAABcAAAAAAAAAH8AAABKAAAAAAAAAAAAAAAAAAAA2gAAAP8AAAD6AAAAwwAAAAAAAADCAAAA/wAAACkAAADqAAAA4QAAAAAAAAD7AAAA/wAAALAAAAAGAAAAAAAAANoAAAD/AAAA+gAAAMMAAAAAAAAAIwAAAP4AAAD/AAAA/wAAAGAAAAAAAAAAAAAAAMkAAAD/AAAAigAAAAAAAADaAAAA/wAAAPoAAADDAAAAAAAAAAAAAAAIAAAAcAAAABkAAAAAAAAAAAAAAAAAAAAAAAAAEgAAAAAAAAAAAAAA2gAAAP8AAAD7AAAAywAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAN4AAAD/AAAAqwAAAP8AAACvAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALIAAAD/AAAAsgAAAAAAAAC5AAAA/wAAAMoAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMkAAAD/AAAAvAAAAAAAAAAAAAAAAAAAAKwAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAArQAAAAAAAAAAwAMAAIABAAAf+AAAP/wAAD/8AAAgBAAAP/wAAD/8AAA//AAAJIwAADHEAAA//AAAP/wAAB/4AACAAQAAwAMAAA==">
    </head>
    <style>
        h2 {
            padding: 0px 20px 0px 20px;
        }
        :root {
            color-scheme: dark;
        }
        body {
            font-family: Helvetica, sans-serif;
        }
        canvas {
            user-select: none;
        }
        @media (prefers-color-scheme: light) {
            body {
                background-color: #eee;
            }
        }
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1c2227;
                color: #e2e1d7;
            }
        }
        .canvas-container {
            width: 900;
            overflow-x: scroll;
            margin-left:20px;
        }
        .header {
            margin-top: 20px;
            margin-left: 20px;
        }
        .header p {
            display: inline;
            vertical-align: top;
            line-height: 28px;
            margin-right: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
        }
        .header .stats {
            margin-top: 20px;
            line-height: 28px;
        }
        .header h1 {
            display: inline;
            vertical-align: top;
            line-height: 28px;
        }

    </style>
  <body>
    <div class="header">
        <h1>Robot Framework Dashboard {{ date }}</h1>
        <div class="stats">
            <p id='suiteCount'></p>
            <p id='testCount'></p>
            <p id='keywordCount'></p>
        </div>
    </div>
    
    <h2>Suite Statistics</h2>
    <div style="display: flex">
        <div class="canvas-container">
            <canvas id="suiteStatistics" width="900", height="540"></canvas>
        </div>
        <div class="canvas-container">
            <canvas id="suitesOverTime" width="900", height="540"></canvas>
        </div>
    </div>

  </body>
  <script>
    // theme
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
        Chart.defaults.color = "#e2e1d7";
        Chart.defaults.borderColor = "rgba(255,255,255,0.1)";
        Chart.defaults.backgroundColor = "rgba(255,255,0,0.1)";
        Chart.defaults.elements.line.borderColor = "rgba(255,255,0,0.4)";
    }
  </script>
  <script>
    // prepare input data
    var suites = {{suites}}.sort((a, b) => new Date(a.run_start).getTime() - new Date(b.run_start).getTime());
    var tests = {{tests}}.sort((a, b) => new Date(a.run_start).getTime() - new Date(b.run_start).getTime());
    // var keywords = {{keywords}}.sort((a, b) => new Date(a.run_start).getTime() - new Date(b.run_start).getTime());

    // set top level counts
    document.getElementById('suiteCount').innerText = 'Suites: ' + suites.length
    document.getElementById('testCount').innerText = 'Tests: ' + tests.length
    document.getElementById('keywordCount').innerText = 'Keywords: ' + {{keywords}}
    // suite statistics
    var passed = []
    var failed = []
    var skipped = []
    var labels = []
    for (const [key, value] of Object.entries(suites)) {
        passed.push(value.passed)
        failed.push(value.failed)
        skipped.push(value.skipped)
        labels.push(`${value.full_name}: ${value.run_start}`)
    }

    const suiteStatisticsData = {
        labels: labels,
        datasets: [
            {
                label: 'Failed',
                data: failed,
                backgroundColor: '#ce3e01',
                stack: 'Stack 0',
            },
            {
                label: 'Skipped',
                data: skipped,
                backgroundColor: '#fed84f',
                stack: 'Stack 0',
            },
            {
                label: 'Passed',
                data: passed,
                backgroundColor: '#97bd61',
                stack: 'Stack 0',
            },
        ]
    };

    Chart.register(ChartDataLabels);
    new Chart("suiteStatistics", {
        type: 'bar',
        data: suiteStatisticsData,
        options: {
            scales: {
                x: {
                    ticks: {
                        display: true,
                        callback: function(value) {
                            return this.getLabelForValue(value).split(':')[0]
                        },
                    },
                    title: {
                        display: true,
                        text: 'Run'
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Amount Of Tests'
                    },
                    grace: '5%'
                }
            },
            interaction: {
                mode: 'x'
            },
            responsive: false,
            plugins: {
                legend: {
                    display: false,
                    labels: {
                        family: 'Helvetica, sans-serif',
                    }
                },
                datalabels: {
                    color: '#000000',
                    align: 'center',
                    anchor: 'center',
                    formatter: function(value) {
                        if(value >0 ){
                            return value
                        } else{
                            value = "";
                            return value;
                        }
                    }
                },
                title: {
                display: true,
                text: 'Suite Statistics'
                }
            }
        }
    });
    // suites over time
    var labels = []
    var sets = []
    var datasets = []
    for (const [run, stats] of Object.entries(suites)) {
        var full_name = stats.full_name
        var run_start = new Date(stats.run_start)
        var elapsed_s = stats.elapsed_s
        if (labels.includes(full_name)) {
            var values = sets[full_name]
            values.push({x: run_start, y: elapsed_s})
            sets[full_name] = values
        } else {
            labels.push(full_name)
            sets[full_name] = [{x: run_start, y: elapsed_s}]
        }
    }
    for (const [run, data] of Object.entries(sets)) {
        datasets.push({label: run, fill: false, borderDash: [5, 5], data: data})
    }

    new Chart("suitesOverTime", {
        type: 'line',
        data: { 
            datasets: datasets 
        },
        options: {
            responsive: false,
            plugins: {
                title: {
                    text: 'Suite Duration Over Time',
                    display: true
                }, 
                datalabels: {
                    display: false,
                },
                legend: {
                    display: true,
                    position: 'right',
                    labels: {
                        family: 'Helvetica, sans-serif',
                        color: '#e2e1d7'
                    }
                },
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        tooltipFormat: 'dd.MM.yyyy - HH:mm:ss.SSS' 
                    },
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Elapsed (seconds)'
                    },
                    grace: '5%'
                }
            }
        }
    });
    </script>
<body>
</html>
